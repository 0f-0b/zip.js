<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>zip.js background page</title>
</head>
<body>
	<input type="file" id="file-input">
	<progress id="unzip-progress" value="0"></progress>
	<progress id="zip-progress" value="0"></progress>
	<script type="text/javascript" src="zip.js"></script>	
	<script type="text/javascript">
		var fileInput = document.getElementById("file-input");
		var zipProgress = document.getElementById("zip-progress");
		var unzipProgress = document.getElementById("unzip-progress");
		webkitRequestFileSystem(TEMPORARY, 1024 * 1024 * 1024, function(filesystem) {
			var rootReader = filesystem.root.createReader("/");
			rootReader.readEntries(function(entries) {
				var i = 0;

				function removeNextEntry() {
					function next() {
						i++;
						removeNextEntry();
					}

					if (i < entries.length)
						entries[i].remove(next, next);
					else
						callback();
				}

				removeNextEntry();
			}, callback);

			function callback() {
				filesystem.root.getFile("test.zip", {
					create : true
				}, function(outputFile) {
					fileInput.addEventListener('change', function(event) {
						var inputFile = event.target.files[0], unzipper = zip.createReader(inputFile), zipper = zip.createWriter(outputFile);

						unzipper.getEntries(function(entries) {
							
							function getEntry(i) {
								var entry = entries[i];
								unzipProgress.value = 0;
								unzipProgress.max = 0;
								zipProgress.value = 0;
								zipProgress.max = 0;
								if (entry)
									entry.getData(function(data) {
										console.log(entry);
										unzipProgress.value = 0;
										unzipProgress.max = 0;
										zipProgress.value = 0;
										zipProgress.max = 0;
										zipper.add(entry.filename, data, null, function() {
											getEntry(i + 1);
										}, function(current, total) {
											zipProgress.value = current;
											zipProgress.max = total;											
										});
									}, function(current, total) {
										unzipProgress.value = current;
										unzipProgress.max = total;
									});
								else
									zipper.close(function() {
										console.log("OK");
									});
							}
							
							getEntry(0);
							
						});

					}, false);
				});
			}
		});
	</script>
</body>
</html>